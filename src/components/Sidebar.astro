---
import { getAllDocs, buildFolderTree, type FolderNode } from '../utils/docs';

interface Props {
  currentPath: string;
}

const { currentPath } = Astro.props;
const docs = await getAllDocs();
const tree = buildFolderTree(docs);

function renderFolder(folder: FolderNode, depth = 0): string {
  const folderId = `folder-${folder.name.toLowerCase().replace(/\s+/g, '-')}-${depth}`;
  const isRoot = folder.name === 'root';
  
  return `
    <div class="mb-1" data-folder>
      ${!isRoot ? `
        <button 
          class="sidebar-folder-button flex items-center w-full py-2 px-3 rounded-lg text-left font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
          style="margin-left: ${depth * 16}px"
          aria-expanded="true"
          aria-controls="${folderId}"
          data-folder-toggle
          id="toggle-${folderId}"
        >
          <svg class="w-4 h-4 mr-2 transition-transform duration-200 folder-chevron" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--theme-textTertiary)">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
          <svg class="w-4 h-4 mr-2" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--theme-textTertiary)">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
          </svg>
          <span>${folder.name}</span>
          <span class="sr-only">toggle folder</span>
        </button>
      ` : ''}
      
      <div id="${folderId}" class="folder-content" ${!isRoot ? 'data-folder-content' : ''}>
        ${folder.files.map((file: typeof folder.files[0]) => {
          const isActive = currentPath === file.path;
          return `
            <a 
              href="${file.path}"
              class="sidebar-link flex items-center py-2 px-3 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 ${
                isActive ? 'sidebar-link-active' : ''
              }"
              style="margin-left: ${(depth + (!isRoot ? 1 : 0)) * 16}px"
              ${isActive ? 'aria-current="page"' : ''}
              data-doc-link
              data-doc-title="${file.title.toLowerCase()}"
            >
              <svg class="w-4 h-4 mr-2 flex-shrink-0 sidebar-link-icon" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <span class="truncate">${file.title}</span>
            </a>
          `;
        }).join('')}
        
        ${folder.children.map((child: FolderNode) => renderFolder(child, depth + 1)).join('')}
      </div>
    </div>
  `;
}
---

<aside 
  class="fixed left-0 top-0 w-82 themed-sidebar-bg themed-border-r flex flex-col themed-shadow transition-transform duration-300 z-40"
  role="navigation"
  aria-label="Documentation navigation"
  id="docs-sidebar"
  style="height: 100dvh;"
>
  <!-- Header -->
  <div class="p-6 themed-border-b flex-shrink-0 themed-sidebar-bg">
    <div class="flex items-center justify-between">
      <a 
        href="/" 
        class="block group focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-lg"
      >
        <h2 class="text-2xl font-bold themed-sidebar-text group-hover:text-indigo-600 transition-colors">
          ðŸ“š Docs
        </h2>
      </a>
    </div>
  </div>

  <!-- Search Box -->
  <div class="p-4 themed-border-b flex-shrink-0 themed-sidebar-bg">
    <div class="relative">
      <label for="docs-search" class="sr-only">Search documentation</label>
      <input
        type="search"
        placeholder="Search docs..."
        class="w-full py-2 pl-10 pr-4 text-sm themed-border rounded-lg themed-sidebar-bg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent themed-sidebar-text placeholder-slate-400"
        aria-label="Search documentation"
        id="docs-search"
      />
      <svg 
        class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none" 
        aria-hidden="true"
        fill="none" 
        stroke="currentColor" 
        viewBox="0 0 24 24"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
  </div>
  
  <!-- Navigation Content -->
  <nav 
    class="flex-1 overflow-y-auto overflow-x-hidden pt-4 pb-4 pr-4 pl-4 themed-sidebar-bg"
    style="min-height: 0;"
    aria-label="Documentation sections"
    id="sidebar-nav"
  >
    <div set:html={renderFolder(tree)} />
  </nav>

  <!-- Footer -->
  <div class="p-4 themed-border-t flex-shrink-0 themed-sidebar-bg">
    <button
      class="flex items-center justify-center w-full py-2 px-4 text-sm themed-sidebar-text hover:bg-slate-50 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500"
      aria-label="Collapse sidebar"
      id="collapse-sidebar"
    >
      <svg class="w-4 h-4 mr-2" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
      </svg>
      Collapse sidebar
    </button>
  </div>
</aside>

<!-- Sidebar toggle button (visible when collapsed) -->
<button
  class="fixed left-0 top-1/2 transform -translate-y-1/2 themed-sidebar-bg themed-border rounded-r-lg p-2 themed-shadow hover:bg-slate-50 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-300 z-50 hidden"
  aria-label="Open sidebar"
  id="open-sidebar"
  style="margin-left: -4px;"
>
  <svg class="w-5 h-5 text-slate-600" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
  </svg>
</button>

<script>
  // Type-safe wrapper to get elements
  function getElement<T extends HTMLElement>(id: string): T | null {
    return document.getElementById(id) as T | null;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const sidebar = getElement<HTMLDivElement>('docs-sidebar');
    const collapseSidebar = getElement<HTMLButtonElement>('collapse-sidebar');
    const openSidebar = getElement<HTMLButtonElement>('open-sidebar');
    const toggleButtons = document.querySelectorAll<HTMLButtonElement>('[data-folder-toggle]');
    const searchInput = getElement<HTMLInputElement>('docs-search');
    
    // Folder toggle functionality
    toggleButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const isExpanded = button.getAttribute('aria-expanded') === 'true';
        const targetId = button.getAttribute('aria-controls');
        const target = targetId ? document.getElementById(targetId) : null;
        const icon = button.querySelector<SVGElement>('.folder-chevron');
        
        if (target && icon) {
          const newExpandedState = !isExpanded;
          button.setAttribute('aria-expanded', String(newExpandedState));
          
          if (newExpandedState) {
            target.style.display = 'block';
            icon.style.transform = 'rotate(0deg)';
          } else {
            target.style.display = 'none';
            icon.style.transform = 'rotate(-90deg)';
          }
        }
      });

      // Keyboard support
      button.addEventListener('keydown', (e: KeyboardEvent) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          button.click();
        }
      });
    });

    // Sidebar collapse/expand
    if (collapseSidebar && openSidebar && sidebar) {
      collapseSidebar.addEventListener('click', () => {
        sidebar.classList.add('-translate-x-full');
        openSidebar.classList.remove('hidden');
        openSidebar.classList.add('block');
        document.dispatchEvent(new CustomEvent('sidebar-collapsed'));
      });
      
      openSidebar.addEventListener('click', () => {
        sidebar.classList.remove('-translate-x-full');
        openSidebar.classList.add('hidden');
        openSidebar.classList.remove('block');
        document.dispatchEvent(new CustomEvent('sidebar-expanded'));
      });
    }

    // Search functionality
    if (searchInput) {
      searchInput.addEventListener('input', (e: Event) => {
        const target = e.target as HTMLInputElement;
        const searchTerm = target.value.toLowerCase().trim();
        const links = document.querySelectorAll<HTMLAnchorElement>('[data-doc-link]');
        const folders = document.querySelectorAll<HTMLDivElement>('[data-folder]');
        
        if (searchTerm === '') {
          // Reset visibility
          links.forEach(link => {
            link.style.display = 'flex';
          });
          folders.forEach(folder => {
            folder.style.display = 'block';
          });
        } else {
          // Hide all folders first
          folders.forEach(folder => {
            folder.style.display = 'none';
          });
          
          // Show matching links and their parent folders
          links.forEach(link => {
            const title = link.getAttribute('data-doc-title') || '';
            if (title.includes(searchTerm)) {
              link.style.display = 'flex';
              
              // Show all parent folders
              let parent = link.closest<HTMLDivElement>('[data-folder]');
              while (parent) {
                parent.style.display = 'block';
                parent = parent.parentElement?.closest<HTMLDivElement>('[data-folder]') || null;
              }
            } else {
              link.style.display = 'none';
            }
          });
        }
      });

      // Clear search on Escape
      searchInput.addEventListener('keydown', (e: KeyboardEvent) => {
        if (e.key === 'Escape' && searchInput.value) {
          e.stopPropagation();
          searchInput.value = '';
          searchInput.dispatchEvent(new Event('input'));
        }
      });
    }

    // Auto-scroll active item into view
    const activeLink = document.querySelector<HTMLAnchorElement>('[aria-current="page"]');
    if (activeLink) {
      setTimeout(() => {
        activeLink.scrollIntoView({ block: 'center', behavior: 'smooth' });
      }, 100);
    }
  });
</script>

<style is:global>
  /* Themed sidebar classes */
  .themed-sidebar-bg {
    background-color: var(--theme-sidebarBg);
  }
  
  .themed-sidebar-text {
    color: var(--theme-sidebarText);
  }
  
  .themed-border {
    border-color: var(--theme-borderPrimary);
  }
  
  .themed-border-r {
    border-right-color: var(--theme-borderPrimary);
  }
  
  .themed-border-b {
    border-bottom-color: var(--theme-borderPrimary);
  }
  
  .themed-border-t {
    border-top-color: var(--theme-borderPrimary);
  }
  
  .themed-shadow {
    box-shadow: 0 1px 3px var(--theme-shadow);
  }
  
  /* Sidebar folder buttons */
  .sidebar-folder-button {
    color: var(--theme-sidebarText);
  }
  
  .sidebar-folder-button:hover {
    background-color: var(--theme-sidebarHover);
  }
  
  /* Sidebar links */
  .sidebar-link {
    color: var(--theme-sidebarText);
  }
  
  .sidebar-link:hover {
    background-color: var(--theme-sidebarHover);
  }
  
  .sidebar-link-active {
    background-color: var(--theme-sidebarActiveBg);
    color: var(--theme-sidebarActive);
    font-weight: 600;
  }
  
  .sidebar-link-active .sidebar-link-icon {
    color: var(--theme-accentPrimary);
  }
  
  .sidebar-link:not(.sidebar-link-active) .sidebar-link-icon {
    color: var(--theme-textTertiary);
  }
  
  .folder-content {
    overflow: visible;
  }

  /* Custom scrollbar */
  nav::-webkit-scrollbar {
    width: 6px;
  }

  nav::-webkit-scrollbar-track {
    background: transparent;
  }

  nav::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }

  nav::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* Focus visible for better keyboard navigation */
  :focus-visible {
    outline: 2px solid #a5b4fc;
    outline-offset: 2px;
  }

  #open-sidebar {
    transition: opacity 0.3s ease, margin-left 0.3s ease;
  }
</style>
