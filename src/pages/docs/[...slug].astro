---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Sidebar from '../../components/Sidebar.astro';
import ThemeSettings from '../../components/ThemeSettings.astro';
import { getAllDocs, processObsidianLinks } from '../../utils/docs';

export async function getStaticPaths() {
  const docs = await getCollection('docs');
  return docs.map(doc => ({
    params: { slug: doc.slug },
    props: { doc },
  }));
}

const { slug } = Astro.params;
const { doc } = Astro.props;

// Respect configured base path
const BASE = import.meta.env.BASE_URL ?? '/';

// Get all docs for link processing
const allDocs = await getAllDocs();

const { Content } = await doc.render();
const title = doc.data.title || doc.slug.split('/').pop()?.replace(/-/g, ' ') || 'Untitled';
---

<Layout title={title}>
  <div class="min-h-screen transition-all duration-300 ease-in-out themed-bg" id="docs-container">
    <Sidebar currentPath={`${BASE}docs/${slug}`} />
    <ThemeSettings />
    
    <!-- Mobile header with menu button -->
    <header class="lg:hidden sticky top-0 z-20 themed-sidebar-bg themed-border-b px-4 py-3">
      <div class="flex items-center justify-between">
        <a 
          href="/" 
          class="text-lg font-semibold themed-text-primary focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded"
        >
          ðŸ“š Docs
        </a>
      </div>
    </header>
    
    <main 
      class="pt-4 lg:pt-8 px-4 lg:px-8 transition-all duration-300 ease-in-out" 
      id="main-content"
      role="main"
    >
      <article class="max-w-5xl mx-auto themed-article rounded-lg themed-shadow p-6 lg:p-8">
        <!-- Breadcrumb navigation -->
        <nav class="mb-6" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2 text-sm themed-text-secondary">
            <li>
              <a href={`${BASE}docs`} class="themed-link focus:outline-none">Documentation</a>
            </li>
            <li class="flex items-center">
              <svg class="w-4 h-4" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
              <span class="ml-2 themed-text-primary font-medium" aria-current="page">{title}</span>
            </li>
          </ol>
        </nav>
        
        <h1 class="text-3xl lg:text-4xl font-bold mb-4 lg:mb-6 themed-text-primary" id="main-heading">{title}</h1>
        {doc.data.description && (
          <p class="text-lg themed-text-secondary mb-6 lg:mb-8">{doc.data.description}</p>
        )}
        <div class="prose prose-lg max-w-none markdown-content" id="doc-content">
          <Content />
        </div>
      </article>
    </main>
  </div>
</Layout>

<style is:global>
  /* Themed classes */
  .themed-bg {
    background-color: var(--theme-bgSecondary);
  }
  
  .themed-article {
    background-color: var(--theme-bgPrimary);
  }
  
  .themed-text-primary {
    color: var(--theme-textPrimary);
  }
  
  .themed-text-secondary {
    color: var(--theme-textSecondary);
  }
  
  .themed-text-tertiary {
    color: var(--theme-textTertiary);
  }
  
  .themed-border {
    border-color: var(--theme-borderPrimary);
  }
  
  .themed-border-b {
    border-bottom-color: var(--theme-borderPrimary);
  }
  
  .themed-sidebar-bg {
    background-color: var(--theme-sidebarBg);
  }
  
  .themed-shadow {
    box-shadow: 0 1px 3px var(--theme-shadow);
  }
  
  .themed-link {
    color: var(--theme-linkColor);
  }
  
  .themed-link:hover {
    color: var(--theme-linkHover);
  }
  
  /* Responsive content width */
  #docs-container {
    padding-left: 0;
  }
  
  @media (min-width: 1024px) {
    #docs-container:not(.sidebar-collapsed) {
      padding-left: 18rem;
    }
  }
  
  /* Main content transitions */
  #main-content {
    margin-left: 0;
  }
  
  @media (min-width: 1024px) {
    #docs-container:not(.sidebar-collapsed) #main-content {
      margin-left: 0;
    }
    
    #docs-container.sidebar-collapsed #main-content {
      margin-left: 0;
    }
  }
  
  /* Typography with theme support */
  .prose {
    color: var(--theme-textPrimary);
  }
  
  .prose h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: var(--theme-textPrimary);
  }
  
  .prose h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: var(--theme-textPrimary);
  }
  
  .prose p {
    margin-bottom: 1rem;
    line-height: 1.75;
    color: var(--theme-textSecondary);
  }
  
  .prose code {
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    background-color: var(--theme-codeInline);
    color: var(--theme-textPrimary);
  }
  
  .prose pre {
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-bottom: 1rem;
    background-color: var(--theme-codeBg);
    color: var(--theme-codeText);
  }
  
  .prose a {
    text-decoration: underline;
    border-radius: 0.25rem;
    color: var(--theme-linkColor);
  }
  
  .prose a:focus {
    outline: none;
    box-shadow: 0 0 0 2px #6366f1;
  }
  
  .prose a:hover {
    color: var(--theme-linkHover);
  }
  
  .prose ul, .prose ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }
  
  .prose li {
    margin-bottom: 0.5rem;
    color: var(--theme-textSecondary);
  }
  
  /* Focus styles */
  .prose a:focus {
    text-decoration: none;
  }
  
  /* Skip to main content link */
  .skip-to-main {
    position: absolute;
    top: 1rem;
    left: 1rem;
    z-index: 50;
    padding: 0.5rem 1rem;
    font-weight: 600;
    border-radius: 0.5rem;
    background-color: var(--theme-bgPrimary);
    color: var(--theme-accentPrimary);
    clip: rect(0, 0, 0, 0);
    border: 0;
    height: 1px;
    width: 1px;
    margin: -1px;
    padding: 0;
    overflow: hidden;
    white-space: nowrap;
  }
  
  .skip-to-main:focus {
    clip: auto;
    height: auto;
    width: auto;
    margin: 0;
    padding: 0.5rem 1rem;
    overflow: visible;
    white-space: normal;
    box-shadow: 0 0 0 2px #6366f1;
  }
  
  /* Mobile optimizations */
  @media (max-width: 640px) {
    .prose {
      font-size: 0.9375rem;
      line-height: 1.7;
    }
    
    .prose h2 {
      font-size: 1.5rem;
    }
    
    .prose h3 {
      font-size: 1.25rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Sync mobile menu button with sidebar component
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileToggle = document.getElementById('mobile-menu-toggle');
    
    if (mobileMenuButton && mobileToggle) {
      mobileMenuButton.addEventListener('click', () => {
        mobileToggle.click();
      });
    }
    
    // Handle sidebar state changes
    document.addEventListener('sidebar-collapsed', () => {
      const docsContainer = document.getElementById('docs-container');
      if (docsContainer) {
        docsContainer.classList.add('sidebar-collapsed');
      }
    });
    
    document.addEventListener('sidebar-expanded', () => {
      const docsContainer = document.getElementById('docs-container');
      if (docsContainer) {
        docsContainer.classList.remove('sidebar-collapsed');
      }
    });
    
    // Skip to main content functionality
    const skipLink = document.createElement('a');
    skipLink.href = '#main-content';
    skipLink.className = 'skip-to-main';
    skipLink.textContent = 'Skip to main content';
    document.body.insertBefore(skipLink, document.body.firstChild);
    
    // Update document title for screen readers
    const mainHeading = document.getElementById('main-heading');
    if (mainHeading) {
      document.title = `${mainHeading.textContent} - Documentation`;
    }
    
    // Add print styles
    const printStyles = document.createElement('style');
    printStyles.textContent = `
      @media print {
        #docs-sidebar,
        #mobile-menu-toggle,
        #mobile-menu-button,
        #expand-sidebar,
        #theme-settings-button,
        nav[aria-label="Document navigation"] {
          display: none !important;
        }
        
        #docs-container {
          padding-left: 0 !important;
        }
        
        #main-content {
          margin-left: 0 !important;
          padding: 0 !important;
        }
        
        article {
          box-shadow: none !important;
          padding: 0 !important;
        }
      }
    `;
    document.head.appendChild(printStyles);
  });
</script>