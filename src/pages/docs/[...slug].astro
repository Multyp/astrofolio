---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Sidebar from '../../components/Sidebar.astro';
import { getAllDocs, processObsidianLinks } from '../../utils/docs';

export async function getStaticPaths() {
  const docs = await getCollection('docs');
  return docs.map(doc => ({
    params: { slug: doc.slug },
    props: { doc },
  }));
}

const { slug } = Astro.params;
const { doc } = Astro.props;

// Get all docs for link processing
const allDocs = await getAllDocs();

const { Content } = await doc.render();
const title = doc.data.title || doc.slug.split('/').pop()?.replace(/-/g, ' ') || 'Untitled';
---

<Layout title={title}>
  <div class="min-h-screen bg-gray-50 transition-all duration-300 ease-in-out" id="docs-container">
    <Sidebar currentPath={`/docs/${slug}`} />
    
    <!-- Mobile header with menu button -->
    <header class="lg:hidden sticky top-0 z-20 bg-white border-b border-gray-200 px-4 py-3">
      <div class="flex items-center justify-between">
        <a 
          href="/" 
          class="text-lg font-semibold text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded"
        >
          ðŸ“š Docs
        </a>
        <div class="flex items-center space-x-3">
          <button
            class="p-2 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            aria-label="Open sidebar"
            id="mobile-menu-button"
          >
            <svg class="w-6 h-6 text-gray-600" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
    </header>
    
    <main 
      class="pt-4 lg:pt-8 px-4 lg:px-8 transition-all duration-300 ease-in-out" 
      id="main-content"
      role="main"
    >
      <article class="max-w-5xl mx-auto bg-white rounded-lg shadow-sm p-6 lg:p-8">
        <!-- Breadcrumb navigation -->
        <nav class="mb-6" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2 text-sm text-gray-600">
            <li>
              <a href="/docs" class="hover:text-indigo-600 focus:outline-none focus:text-indigo-600">Documentation</a>
            </li>
            <li class="flex items-center">
              <svg class="w-4 h-4" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
              <span class="ml-2 text-gray-900 font-medium" aria-current="page">{title}</span>
            </li>
          </ol>
        </nav>
        
        <h1 class="text-3xl lg:text-4xl font-bold mb-4 lg:mb-6 text-gray-900" id="main-heading">{title}</h1>
        {doc.data.description && (
          <p class="text-lg text-gray-600 mb-6 lg:mb-8">{doc.data.description}</p>
        )}
        <div class="prose prose-lg max-w-none markdown-content" id="doc-content">
          <Content />
        </div>
        
        <!-- Previous/Next navigation -->
        <nav class="mt-12 pt-8 border-t border-gray-200" aria-label="Document navigation">
          <div class="flex flex-col sm:flex-row justify-between gap-4">
            <a 
              href="#" 
              class="group flex items-center p-4 rounded-lg border border-gray-200 hover:border-indigo-300 hover:bg-indigo-50 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500"
              aria-label="Previous document"
            >
              <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-indigo-600" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
              <div>
                <div class="text-sm text-gray-500 group-hover:text-indigo-600">Previous</div>
                <div class="font-medium text-gray-900 group-hover:text-indigo-900">Getting Started</div>
              </div>
            </a>
            <a 
              href="#" 
              class="group flex items-center justify-end p-4 rounded-lg border border-gray-200 hover:border-indigo-300 hover:bg-indigo-50 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500"
              aria-label="Next document"
            >
              <div class="text-right">
                <div class="text-sm text-gray-500 group-hover:text-indigo-600">Next</div>
                <div class="font-medium text-gray-900 group-hover:text-indigo-900">Advanced Topics</div>
              </div>
              <svg class="w-5 h-5 ml-3 text-gray-400 group-hover:text-indigo-600" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          </div>
        </nav>
      </article>
    </main>
  </div>
</Layout>

<style is:global>
  @reference "../../styles/global.css";
  
  /* Responsive content width */
  #docs-container {
    padding-left: 0;
  }
  
  @media (min-width: 1024px) {
    #docs-container:not(.sidebar-collapsed) {
      padding-left: 18rem; /* Sidebar width */
    }
  }
  
  /* Main content transitions */
  #main-content {
    margin-left: 0;
  }
  
  @media (min-width: 1024px) {
    #docs-container:not(.sidebar-collapsed) #main-content {
      margin-left: 0;
    }
    
    #docs-container.sidebar-collapsed #main-content {
      margin-left: 0;
    }
  }
  
  /* Typography */
  .prose {
    @apply text-gray-700;
  }
  .prose h2 {
    @apply text-2xl font-bold mt-8 mb-4 text-gray-900;
  }
  .prose h3 {
    @apply text-xl font-semibold mt-6 mb-3 text-gray-900;
  }
  .prose p {
    @apply mb-4 leading-relaxed;
  }
  .prose code {
    @apply bg-gray-100 px-1 py-0.5 rounded text-sm font-mono;
  }
  .prose pre {
    @apply bg-gray-900 text-gray-100 p-4 rounded-lg overflow-x-auto mb-4;
  }
  .prose a {
    @apply text-indigo-600 hover:text-indigo-800 underline focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 rounded;
  }
  .prose ul, .prose ol {
    @apply mb-4 pl-6;
  }
  .prose li {
    @apply mb-2;
  }
  
  /* Focus styles */
  .prose a:focus {
    @apply no-underline;
  }
  
  /* Skip to main content link */
  .skip-to-main {
    @apply sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-white focus:text-indigo-600 focus:font-semibold focus:rounded-lg focus:ring-2 focus:ring-indigo-500;
  }
  
  /* Mobile optimizations */
  @media (max-width: 640px) {
    .prose {
      font-size: 0.9375rem;
      line-height: 1.7;
    }
    
    .prose h2 {
      font-size: 1.5rem;
    }
    
    .prose h3 {
      font-size: 1.25rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Sync mobile menu button with sidebar component
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileToggle = document.getElementById('mobile-menu-toggle');
    
    if (mobileMenuButton && mobileToggle) {
      mobileMenuButton.addEventListener('click', () => {
        mobileToggle.click();
      });
    }
    
    // Handle sidebar state changes
    document.addEventListener('sidebar-collapsed', () => {
      const docsContainer = document.getElementById('docs-container');
      if (docsContainer) {
        docsContainer.classList.add('sidebar-collapsed');
      }
    });
    
    document.addEventListener('sidebar-expanded', () => {
      const docsContainer = document.getElementById('docs-container');
      if (docsContainer) {
        docsContainer.classList.remove('sidebar-collapsed');
      }
    });
    
    // Skip to main content functionality
    const skipLink = document.createElement('a');
    skipLink.href = '#main-content';
    skipLink.className = 'skip-to-main';
    skipLink.textContent = 'Skip to main content';
    document.body.insertBefore(skipLink, document.body.firstChild);
    
    // Update document title for screen readers
    const mainHeading = document.getElementById('main-heading');
    if (mainHeading) {
      document.title = `${mainHeading.textContent} - Documentation`;
    }
    
    // Add print styles
    const printStyles = document.createElement('style');
    printStyles.textContent = `
      @media print {
        #docs-sidebar,
        #mobile-menu-toggle,
        #mobile-menu-button,
        #expand-sidebar,
        nav[aria-label="Document navigation"] {
          display: none !important;
        }
        
        #docs-container {
          padding-left: 0 !important;
        }
        
        #main-content {
          margin-left: 0 !important;
          padding: 0 !important;
        }
        
        article {
          box-shadow: none !important;
          padding: 0 !important;
        }
      }
    `;
    document.head.appendChild(printStyles);
  });
</script>
